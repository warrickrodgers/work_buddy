generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
    id Int @id @default(autoincrement())
    email String @unique
    first_name String
    last_name String
    created_at DateTime @default(now())
    last_login DateTime @default(now())
    job_title String
    company String
    password_hash String
    auth_method String
    problem_request ProblemRequest[]
    insight_feedback InsightFeedback[]
    conversations Conversation[]
    challenges Challenge[]
}

// For one-time data analysis
model ProblemRequest {
    id Int @id @default(autoincrement())
    user User @relation(fields: [user_id], references: [id])
    user_id Int
    title String
    role_description String
    problem_description String
    problem_parameters String
    problem_insights String
    solution_summary String
    problem_data DataUpload[]
    created_at DateTime @default(now())
    processed_at DateTime @default(now())
    problem_status ProblemRequestStatus
    metric_temp MetricTemplate?
}


model DataUpload {
    id Int @id @default(autoincrement())
    problem_request ProblemRequest @relation(fields: [problem_request_id], references: [id])
    problem_request_id Int
    file_url String
    filename String
    source_type String
    created_at DateTime @default(now())
    data_analasys_result DataAnalysisResult?
}

model DataAnalysisResult {
    id Int @id @default(autoincrement())
    data_upload DataUpload @relation(fields: [data_upload_id], references: [id])
    data_upload_id Int @unique
    summary String
    inferred_schema Json
    outliers_found String[]
    metrics_highlighted String[]
    created_at DateTime @default(now())
    analysed_at DateTime @default(now())
}

model InsightFeedback {
    id Int @id @default(autoincrement())
    user User @relation(fields: [user_id], references: [id])
    user_id Int
    rating Int
    comment String
    created_at DateTime @default(now())
}

model MetricTemplate {
    id Int @id @default(autoincrement())
    problem_request ProblemRequest @relation(fields: [problem_request_id], references: [id])
    problem_request_id Int @unique
    name String
    description String
    source Int
    metric_type String
    created_at DateTime @default(now())
}

enum ProblemRequestStatus {
    PENDING
    PROCESSING
    DONE
    DID_NOT_MEET
}

enum ConversationType {
  GENERAL
  CHALLENGE
}

model Conversation {
  id                Int                @id @default(autoincrement())
  user              User               @relation(fields: [user_id], references: [id])
  user_id           Int
  title             String             @default("New Conversation")
  conversation_type ConversationType   @default(GENERAL)
  challenge_id      Int?               @unique
  challenge         Challenge?         @relation(fields: [challenge_id], references: [id])
  created_at        DateTime           @default(now())
  updated_at        DateTime           @updatedAt
  messages          ChatMessage[]
  is_archived       Boolean            @default(false)
  
  @@index([user_id])
}

model Challenge {
  id                Int            @id @default(autoincrement())
  user              User           @relation(fields: [user_id], references: [id])
  user_id           Int
  title             String
  description       String         @db.Text
  category          ChallengeCategory
  challenge_type    ChallengeType
  audience_type     AudienceType
  employee_id       String?
  team_id           String?
  start_date        DateTime
  end_date          DateTime?
  success_criteria  String         @db.Text
  metrics           String?        @db.Text
  ai_notes          String?        @db.Text
  status            ChallengeStatus @default(ACTIVE)
  progress          Int            @default(0)
  created_at        DateTime       @default(now())
  updated_at        DateTime       @updatedAt
  completed_at      DateTime?
  
  // Dedicated chat thread for this challenge
  conversation      Conversation?
  check_ins         ChallengeCheckIn[]
  
  @@index([user_id])
  @@index([status])
}

model ChallengeCheckIn {
  id              Int       @id @default(autoincrement())
  challenge       Challenge @relation(fields: [challenge_id], references: [id], onDelete: Cascade)
  challenge_id    Int
  
  // Check-in data
  notes           String    @db.Text
  progress_update Int       // Progress percentage at this check-in
  sentiment       String?   // positive, neutral, negative
  ai_feedback     String?   @db.Text  // AI-generated feedback/encouragement
  
  created_at      DateTime  @default(now())
  
  @@index([challenge_id])
}

enum ChallengeCategory {
  COMMUNICATION
  PRODUCTIVITY
  LEADERSHIP
  CULTURE
  SKILLS
  PROCESS
}

enum ChallengeType {
  HABIT
  SKILL
  BEHAVIOR
  PERFORMANCE
  ACCOUNTABILITY
}

enum AudienceType {
  INDIVIDUAL
  TEAM
  ORGANIZATION
}

enum ChallengeStatus {
  ACTIVE
  COMPLETED
  PAUSED
  CANCELLED
}

model ChatMessage {
  id              Int           @id @default(autoincrement())
  conversation    Conversation  @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  conversation_id Int
  role            MessageRole
  content         String        @db.Text
  created_at      DateTime      @default(now())
  
  @@index([conversation_id])
}

enum MessageRole {
  USER
  ASSISTANT
}